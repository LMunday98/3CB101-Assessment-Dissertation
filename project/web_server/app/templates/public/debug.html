<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug screen</title>

  <!-- CSS -->
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='assets/css/main.css') }}">

  <!-- CDNs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

  <!-- Custom fonts for this template-->
  <link href="{{ url_for('static',filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="{{ url_for('static',filename='assets/css/sb-admin-2.css') }}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@1.8.0"></script>
</head>
<body>
  <!-- Socket server calls -->
  <div class="d-flex justify-content-center">
    <form class="row">
      <a class="col-sm" href=# id=calibrate><button type="button" class='btn btn-primary btn-lg'>Calibrate</button></a>
      <a class="col-sm" href=# id=session_start><button class='btn btn-success btn-lg'>Start Session</button></a>
      <a class="col-sm" href=# id=session_end><button class='btn btn-warning btn-lg'>End Session</button></a>
      <a class="col-sm" href=# id=disconnect_all><button class='btn btn-danger btn-lg'>Disconnect All</button></a>
      <a class="col-sm" href=# id=get_data><button class='btn btn-info btn-lg'>Get Data</button></a>
    </form>
  </div>
  <div id="session_satus"></div>
  
  <br>

  <!-- Rowing data table-->
  {% from "components/data_table.html" import create_data_table with context %}
  {{ create_data_table () }}

  <!-- Chart containers -->
  <div class="row">

    <p>
      <button id="dataset_rx">rx</button>
      <button id="dataset_ry">ry</button>
    </p>

    <div class="col">

        <!-- Area Chart -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Realtime RX Chart</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="realtime_chart"></canvas>
                </div>
            </div>
        </div>
        
    </div>
  </div>

  <!-- Bootstrap core JavaScript-->
  <script src="{{ url_for('static',filename='vendor/jquery/jquery.min.js') }}"></script>
  <script src="{{ url_for('static',filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

  <!-- Js handlers -->
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/data_stream.js') }}"></script>
  <!-- <script type="text/javascript" src="{{ url_for('static', filename='assets/js/datastream_manager.js') }}"></script> -->
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/socket_calls.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/chart-realtime.js') }}"></script>

  <script>
    let rower_indexes = [0, 1, 2, 3];
    let data_stream = new DataStream()
    create_graph(data_stream);

    setInterval(function(){ 

      rower_indexes.forEach(rower_index => {
        var call_url = '/get_data?rower_index=' + rower_index;
        $.getJSON(call_url, function(results) {

          data_stream.update_data(rower_index, results);
          update_table(results);
        } );
      });

    }, 100);
        
    function update_table(results) {
      var info_dict = results['info'];
      var data_dict = results['data'];
      
      jQuery.each(data_dict, function(field, val) {
          element_id = info_dict['seat'] + field;
          display_data(element_id, val);
      });

      element_id = info_dict['seat'] + 'datetime'
      datetime = info_dict['datetime'];
      display_data(element_id, datetime);
    }
  
    function display_data(element_id, data) {
        html_element = document.getElementById(element_id);
        html_element.innerHTML = data;  
    }
/*
    document.getElementById('dataset_rx').addEventListener('click', function() {
      console.log("dataset_rx");
      data_stream.set_measurement('rx');
      destroy_data();
    });

    document.getElementById('dataset_ry').addEventListener('click', function() {
      console.log("dataset_ry");
      data_stream.set_measurement('ry');
      destroy_data();
	  });
*/
    bind_chart_button('dataset_rx', 'rx');
    bind_chart_button('dataset_ry', 'ry');

    function bind_chart_button(element_id, measurement_label) {
      document.getElementById(element_id).addEventListener('click', function() {
        console.log(element_id);
        data_stream.set_measurement(measurement_label);
        destroy_data();
	    });
    }

    function destroy_data() {
      console.log("destroy");
      window.myChart.config.data.datasets.forEach(function(dataset) {
        dataset.data = [];
      });
    }
        
  </script>
</body>
</html>