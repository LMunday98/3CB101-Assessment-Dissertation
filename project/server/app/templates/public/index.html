<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YSJBC</title>
  <!-- CSS -->
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='assets/css/main.css') }}">
  <!-- Js -->
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/rower_chart.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/rower.js') }}"></script>
  <!-- CDNs -->
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>
<body>

  <!-- Socket server call -->
  <form>
    <a href=# id=calibrate><button class='btn btn-default'>Calibrate</button></a>
    <a href=# id=session_start><button class='btn btn-default'>Start Session</button></a>
    <a href=# id=session_end><button class='btn btn-default'>End Session</button></a>
  </form>
  <div id="session_satus"></div>
  <br>

  <!-- Rowing data table-->
  {% from "components/data_table.html" import create_data_table with context %}
  {{ create_data_table () }}

  <!-- Chart containers -->
  <div id="chartContainer_rx" style="height: 300px; width: 100%;"></div>
  <div id="chartContainer_ry" style="height: 300px; width: 100%;"></div>

  <script>
    const dataLength = 100;
    const seats = ["bow", "bow2", "stroke2", "stroke"];
    const measurements = ["gx", "gy", "gz", "sax", "say", "saz", "rx", "ry"];

    let charts = gen_charts(dataLength, seats);
    let rowers = gen_rowers(seats, charts);

    window.onload = function () { 

      var eventSource = new EventSource("/stream"); 
      eventSource.onmessage = function(e) {
        if (e.data == "") {
          display_data("session_satus", "Session: Ended")
          charts = gen_charts(dataLength, seats);
          rowers = gen_rowers(seats, charts);
          clear_table_data();
        } else {
          display_data("session_satus", "Session: In Progress")
          var data_array = e.data.split(',');
          display_data("datetime", get_datetime(data_array));

          rowers.forEach(rower => {
            table_data = data_array.slice(1 + rower.get_offset(), 9 + rower.get_offset());
            rower.set_data(table_data);
            rower.update_table_data();
            rower.update_chart_data();
          });
        }
      };
    };

    function clear_table_data() {
        seats.forEach(seat_name => {
          measurements.forEach(measurement => {
            var data_id = seat_name + measurement;
            var reset_data = seat_name + " " + measurement;
            display_data(data_id, reset_data)
          });
        });
    }

    function gen_rowers(seats, charts) {
      let new_rowers = [];
      seats.forEach(seat => {
        new_rowers.push(new Rower(seat, charts));
      });
      return new_rowers;
    }

    function gen_charts(dataLength, seats) {
      let new_charts = [];
      let chart_rx = new RowerChart("A graph of rx:", "rx", "chartContainer_rx", seats.length, dataLength);
      let chart_ry = new RowerChart("A graph of ry:", "ry", "chartContainer_ry", seats.length, dataLength);
      
      new_charts.push(chart_rx);
      new_charts.push(chart_ry);
      return new_charts;
    }

    function get_datetime(data_array) {
      timestamp = data_array[data_array.length - 1];
      datetime = timestamp.split('.')[0];
      return datetime;
    }

    function display_data(element_id, data) {
      html_element = document.getElementById(element_id)
      html_element.innerHTML = data;
    }
  </script>

<script type=text/javascript>
  $(function() {
    $('a#calibrate').bind('click', function() {
      $.getJSON('{{ url_for('socket_call', socket_code='cal') }}',
        function(data) {
      });
      return false;
    });
  });

  $(function() {
    $('a#session_start').bind('click', function() {
      $.getJSON('{{ url_for('socket_call', socket_code='session_start') }}',
        function(data) {
      });
      return false;
    });
  });
  
  $(function() {
    $('a#session_end').bind('click', function() {
      $.getJSON('{{ url_for('socket_call', socket_code='session_end') }}',
        function(data) {
      });
      return false;
    });
  });
</script>
</body>
</html>