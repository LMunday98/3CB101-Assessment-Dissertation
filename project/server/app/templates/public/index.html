<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YSJBC</title>

  <!-- CSS -->
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='assets/css/main.css') }}">
  <!-- Js -->
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/rower_chart.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/datastream.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/rower.js') }}"></script>
  <!-- CDNs -->
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</head>
<body>
  <!-- Rowing data table-->
  {% from "components/data_table.html" import create_data_table with context %}
  {{ create_data_table () }}

  <!-- Chart containers -->
  <div id="chartContainer_rx" style="height: 300px; width: 100%;"></div>
  <div id="chartContainer_ry" style="height: 300px; width: 100%;"></div>

  <script>
    const dataLength = 100;
    const seats = ["bow", "bow2", "stroke2", "stroke"];
    let chart_rx = new RowerChart("A graph of rx:", "rx", "chartContainer_rx", seats.length, dataLength);
    let chart_ry = new RowerChart("A graph of ry:", "ry", "chartContainer_ry", seats.length, dataLength);
    let charts = [chart_rx, chart_ry];

    window.onload = function () { 

      var eventSource = new EventSource("/stream");
      eventSource.onmessage = function(e) {

        var data_array = e.data.split(',');
        display_data("datetime", get_datetime(data_array));

        for (let rower_index = 0; rower_index < seats.length; rower_index++) {
          offset = rower_index * 9;

          rower_data = data_array.slice(1 + offset, 9 + offset);
          let rower = new Rower(seats[rower_index], rower_data);
          rower.display_all_data();

          charts.forEach(chart => {
            data_to_plot = data_array[offset + chart.get_measurement_index()]
            chart.update_chart(rower_index, data_to_plot);
          });
        }
      };
    };

    function get_datetime(data_array) {
      timestamp = data_array[data_array.length - 1];
      datetime = timestamp.split('.')[0];
      return datetime;
    }

    function display_data(element_id, data) {
      html_element = document.getElementById(element_id)
      html_element.innerHTML = data;
    }
  </script>
</body>
</html>