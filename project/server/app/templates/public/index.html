<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YSJBC</title>

  <!-- CSS -->
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='assets/css/main.css') }}">
  <!-- Js -->
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/rower_chart.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/datastream.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='assets/js/rower.js') }}"></script>
  <!-- CDNs -->
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</head>
<body>
  <!-- Rowing data table-->
  {% from "components/data_table.html" import create_data_table with context %}
  {{ create_data_table () }}

  <!-- Chart containers -->
  <div id="chartContainer_rx" style="height: 300px; width: 100%;"></div>
  <div id="chartContainer_ry" style="height: 300px; width: 100%;"></div>

  <script>
    const num_rowers = 4;
    const dataLength = 100;
    let chart_rx = new RowerChart("A graph of rx:", "rx", "chartContainer_rx", num_rowers, dataLength);
    let chart_ry = new RowerChart("A graph of ry:", "ry", "chartContainer_ry", num_rowers, dataLength);

    window.onload = function () { 

      var seats = ["bow", "bow2", "stroke2", "stroke"];
      var measurements = ["gx", "gy", "gz", "sax", "say", "saz", "rx", "ry"];
        
      var eventSource = new EventSource("/stream");
      eventSource.onmessage = function(e) {
        var data_array = e.data.split(',');

        timestamp = data_array[data_array.length - 1];
        datetime = timestamp.split('.')[0];
        display_data("datetime", datetime);

        for (let rower_index = 0; rower_index < num_rowers; rower_index++) {
          offset = rower_index * 9;

          rower_data = data_array.slice(1 + offset, 9 + offset);
          let rower = new Rower(seats[rower_index], rower_data);
          rower.display_all_data();
          
          data_to_plot = data_array[offset + chart_rx.get_measurement_index()]
          chart_rx.update_chart(rower_index, data_to_plot);

          data_to_plot = data_array[offset + chart_ry.get_measurement_index()]
          chart_ry.update_chart(rower_index, data_to_plot);
        }
      };
    };

    function display_data(element_id, data) {
      html_element = document.getElementById(element_id)
      html_element.innerHTML = data;
    }
  </script>
</body>
</html>